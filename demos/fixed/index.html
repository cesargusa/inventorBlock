<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Blockly Demo: Fixed Blockly</title>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>
  <script src="../fixed/js/wait_block.js"></script>
  <script src="acorn_interpreter.js"></script>

  <link rel="stylesheet" type="text/css" href="../../demos/fixed/index.css" media="screen" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" 
  integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
</head>
<body>
  <header>
    <div class="cabecera">
    <div class="logo"><a href="https://academiadeinventores.com/"><img src="https://academiadeinventores.com/wp-content/uploads/2020/06/logotipo_academia_blanco.svg" width="280px" alt="Academia de inventores"></div>
      <div class="items">
        <div class="item"><img src="../fixed/assets/Logo2.JPG" width="356px"></div>
        <div class="item"><h4><a href="https://developers.google.com/blockly/">Blockly</a> &gt;<a href="../index.html">Demos</a> &gt; Fixed Blockly</h4></div>
      </div>
    </div>
  </header>
  <p>Utiliza los bloques para poder crear tu propio código</p>

  <p>&rarr; Más informaión en: <a href="https://developers.google.com/blockly/guides/configure-blockly/web/fixed-size">injecting fixed-sized Blockly</a>&hellip;</p>

  <p>
    <button class="button1" onclick="showCode()">Mostrar JavaScript</button>
    <button class="button2" onclick="runCode()">Iniciar JavaScript</button>
  </p>
  <div class="playarea">
    <div id="blocklyDiv" style="height: 480px; width: 600px;">
      <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <!-- Logica -->
        <category name="Logica" colour="210">
          <block type="controls_if"></block>
          <block type="logic_compare"></block>
          <block type="controls_if">
            <mutation else="1"></mutation>
          </block>
          <block type="controls_if">
            <mutation elseif="1" else="1"></mutation>
          </block>
          <block type="logic_operation"></block>
          <block type="logic_negate"></block>
          <block type="logic_boolean"></block>
          <block type="logic_null"></block>
          <block type="logic_ternary"></block>
        </category>

        <!-- Loops -->
        <category name="Loops" colour="%{BKY_LOOPS_HUE}">
          <block type="controls_repeat_ext">
            <value name="TIMES">
              <block type="math_number">
                <field name="NUM">10</field>
              </block>
            </value>
          </block>
          <block type="controls_whileUntil"></block>
          <block type="controls_for">
            <field name="VAR">i</field>
            <value name="FROM">
              <block type="math_number">
                <field name="NUM">1</field>
              </block>
            </value>
            <value name="TO">
              <block type="math_number">
                <field name="NUM">10</field>
              </block>
            </value>
            <value name="BY">
              <block type="math_number">
                <field name="NUM">1</field>
              </block>
            </value>
          </block>
          <block type="controls_forEach"></block>
          <block type="controls_flow_statements"></block>
        </category>

        <!-- Matematicas -->
        <category name="Matematicas" colour="230">
          <block type="math_number">
            <field name="NUM">123</field>
          </block>
          <block type="math_arithmetic"></block>
          <block type="math_single"></block>
          <block type="math_trig"></block>
          <block type="math_constant"></block>
          <block type="math_number_property"></block>
          <block type="math_round"></block>
          <block type="math_on_list"></block>
          <block type="math_modulo"></block>
          <block type="math_constrain">
            <value name="LOW">
              <block type="math_number">
                <field name="NUM">1</field>
              </block>
            </value>
            <value name="HIGH">
              <block type="math_number">
                <field name="NUM">100</field>
              </block>
            </value>
          </block>
          <block type="math_random_int">
            <value name="FROM">
              <block type="math_number">
                <field name="NUM">1</field>
              </block>
            </value>
            <value name="TO">
              <block type="math_number">
                <field name="NUM">100</field>
              </block>
            </value>
          </block>
          <block type="math_random_float"></block>
          <block type="math_atan2"></block>
        </category>

        <!-- Texto -->
        <category name="Texto" colour="150">
          <block type="text"></block>
          <block type="text_print"></block>
        </category>

        <!-- Variables y funciones -->
        <sep></sep>
        <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
        </category>
        <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
        </category>

        <!-- Ejemplos -->
        <sep></sep>
        <category name="Library" expanded="true">
          <category name="Randomize">
            <block type="procedures_defnoreturn">
              <mutation>
                <arg name="list"></arg>
              </mutation>
              <field name="NAME">randomize</field>
              <statement name="STACK">
                <block type="controls_for" inline="true">
                  <field name="VAR">x</field>
                  <value name="FROM">
                    <block type="math_number">
                      <field name="NUM">1</field>
                    </block>
                  </value>
                  <value name="TO">
                    <block type="lists_length" inline="false">
                      <value name="VALUE">
                        <block type="variables_get">
                          <field name="VAR">list</field>
                        </block>
                      </value>
                    </block>
                  </value>
                  <value name="BY">
                    <block type="math_number">
                      <field name="NUM">1</field>
                    </block>
                  </value>
                  <statement name="DO">
                    <block type="variables_set" inline="false">
                      <field name="VAR">y</field>
                      <value name="VALUE">
                        <block type="math_random_int" inline="true">
                          <value name="FROM">
                            <block type="math_number">
                              <field name="NUM">1</field>
                            </block>
                          </value>
                          <value name="TO">
                            <block type="lists_length" inline="false">
                              <value name="VALUE">
                                <block type="variables_get">
                                  <field name="VAR">list</field>
                                </block>
                              </value>
                            </block>
                          </value>
                        </block>
                      </value>
                      <next>
                        <block type="variables_set" inline="false">
                          <field name="VAR">temp</field>
                          <value name="VALUE">
                            <block type="lists_getIndex" inline="true">
                              <mutation statement="false" at="true"></mutation>
                              <field name="MODE">GET</field>
                              <field name="WHERE">FROM_START</field>
                              <value name="AT">
                                <block type="variables_get">
                                  <field name="VAR">y</field>
                                </block>
                              </value>
                              <value name="VALUE">
                                <block type="variables_get">
                                  <field name="VAR">list</field>
                                </block>
                              </value>
                            </block>
                          </value>
                          <next>
                            <block type="lists_setIndex" inline="false">
                              <value name="AT">
                                <block type="variables_get">
                                  <field name="VAR">y</field>
                                </block>
                              </value>
                              <value name="LIST">
                                <block type="variables_get">
                                  <field name="VAR">list</field>
                                </block>
                              </value>
                              <value name="TO">
                                <block type="lists_getIndex" inline="true">
                                  <mutation statement="false" at="true"></mutation>
                                  <field name="MODE">GET</field>
                                  <field name="WHERE">FROM_START</field>
                                  <value name="AT">
                                    <block type="variables_get">
                                      <field name="VAR">x</field>
                                    </block>
                                  </value>
                                  <value name="VALUE">
                                    <block type="variables_get">
                                      <field name="VAR">list</field>
                                    </block>
                                  </value>
                                </block>
                              </value>
                              <next>
                                <block type="lists_setIndex" inline="false">
                                  <value name="AT">
                                    <block type="variables_get">
                                      <field name="VAR">x</field>
                                    </block>
                                  </value>
                                  <value name="LIST">
                                    <block type="variables_get">
                                      <field name="VAR">list</field>
                                    </block>
                                  </value>
                                  <value name="TO">
                                    <block type="variables_get">
                                      <field name="VAR">temp</field>
                                    </block>
                                  </value>
                                </block>
                              </next>
                            </block>
                          </next>
                        </block>
                      </next>
                    </block>
                  </statement>
                </block>
              </statement>
            </block>
          </category>
          <category name="Jabberwocky">
            <block type="text_print">
              <value name="TEXT">
                <block type="text">
                  <field name="TEXT">'Twas brillig, and the slithy toves</field>
                </block>
              </value>
              <next>
                <block type="text_print">
                  <value name="TEXT">
                    <block type="text">
                      <field name="TEXT">  Did gyre and gimble in the wabe:</field>
                    </block>
                  </value>
                  <next>
                    <block type="text_print">
                      <value name="TEXT">
                        <block type="text">
                          <field name="TEXT">All mimsy were the borogroves,</field>
                        </block>
                      </value>
                      <next>
                        <block type="text_print">
                          <value name="TEXT">
                            <block type="text">
                              <field name="TEXT">  And the mome raths outgrabe.</field>
                            </block>
                          </value>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
            <block type="text_print">
              <value name="TEXT">
                <block type="text">
                  <field name="TEXT">"Beware the Jabberwock, my son!</field>
                </block>
              </value>
              <next>
                <block type="text_print">
                  <value name="TEXT">
                    <block type="text">
                      <field name="TEXT">  The jaws that bite, the claws that catch!</field>
                    </block>
                  </value>
                  <next>
                    <block type="text_print">
                      <value name="TEXT">
                        <block type="text">
                          <field name="TEXT">Beware the Jubjub bird, and shun</field>
                        </block>
                      </value>
                      <next>
                        <block type="text_print">
                          <value name="TEXT">
                            <block type="text">
                              <field name="TEXT">  The frumious Bandersnatch!"</field>
                            </block>
                          </value>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </category>
        </category>
      </xml>
    </div>
    <textarea id="output" disabled="disabled" style="display: inline-block; height: 480px; width: 38%;">Output</textarea>
  </div>

  <script src="../../msg/js/es.js"></script>
  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
        {media: '../../media/',
         toolbox: document.getElementById('toolbox')});

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      alert(code);
    }

    function runCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }
  </script>

  <script>
    var outputArea = document.getElementById('output');
    var runButton = document.getElementsByClassName('button2');
    var myInterpreter = null;
    var runner;

    function initApi(interpreter, globalObject) {
      // Add an API function for the alert() block, generated for "text_print" blocks.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        outputArea.value = outputArea.value + '\n' + text;
      };
      interpreter.setProperty(globalObject, 'alert',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(globalObject, 'prompt',
          interpreter.createNativeFunction(wrapper));

      // Add an API for the wait block.  See wait_block.js
      initInterpreterWaitForSeconds(interpreter, globalObject);

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(globalObject, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));
    }

    var highlightPause = false;
    var latestCode = '';

    function highlightBlock(id) {
      demoWorkspace.highlightBlock(id);
      highlightPause = true;
    }

    function resetStepUi(clearOutput) {
      demoWorkspace.highlightBlock(null);
      highlightPause = false;
      runButton.disabled = '';

      if (clearOutput) {
        outputArea.value = 'Program output:\n=================';
      }
    }

    function generateCodeAndLoadIntoInterpreter() {
      // Generate JavaScript code and parse it.
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      latestCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);

      resetStepUi(true);
    }

    function resetInterpreter() {
      myInterpreter = null;
      if (runner) {
        clearTimeout(runner);
        runner = null;
      }
    }

    function runCode() {
      if (!myInterpreter) {
        // First statement of this code.
        // Clear the program output.
        resetStepUi(true);
        runButton.disabled = 'disabled';

        // And then show generated code in an alert.
        // In a timeout to allow the outputArea.value to reset first.
        setTimeout(function() {
          alert('Ready to execute the following code\n' +
            '===================================\n' +
            latestCode);
          // Begin execution
          highlightPause = false;
          myInterpreter = new Interpreter(latestCode, initApi);
          runner = function() {
            if (myInterpreter) {
              var hasMore = myInterpreter.run();
              if (hasMore) {
                // Execution is currently blocked by some async call.
                // Try again later.
                setTimeout(runner, 10);
              } else {
                // Program is complete.
                outputArea.value += '\n\n<< Program complete >>';
                resetInterpreter();
                resetStepUi(false);
              }
            }
          };
          runner();
        }, 1);
        return;
      }
    }

    // Load the interpreter now, and upon future changes.
    generateCodeAndLoadIntoInterpreter();
    demoWorkspace.addChangeListener(function(event) {
      if (!(event instanceof Blockly.Events.Ui)) {
        // Something changed. Parser needs to be reloaded.
        resetInterpreter();
        generateCodeAndLoadIntoInterpreter();
      }
    });
  </script>

</body>
</html>
